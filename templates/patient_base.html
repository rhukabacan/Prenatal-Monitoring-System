<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Prenatal Care</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --header-height: 70px;
            --header-height-mobile: 60px;
            --primary-color: #FF69B4;
            --secondary-color: #FF1493;
            --light-pink: #FFF0F7;
            --medium-pink: #FFB6C1;
            --primary-gradient: linear-gradient(135deg, #FF69B4, #FF1493);
            --navbar-bg: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }


        body {
            min-height: 100vh;
            background-color: #F3F4F6;
            padding-top: calc(var(--header-height) + 10px);
        }

        .navbar-main {
            background: var(--navbar-bg);
            height: var(--header-height);
            padding: 0 1rem;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 1030;
            transition: height 0.3s ease;
        }

        .navbar-brand {
            color: white !important;
            font-weight: 600;
            padding: 0.5rem 1rem;
            margin-right: 2rem;
            font-size: 1.25rem;
            white-space: nowrap;
        }

        .navbar-brand i {
            font-size: 1.2rem;
        }

        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            padding: 0.75rem 1rem;
            position: relative;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            color: white !important;
        }

        .navbar-nav .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0.75rem;
            right: 0.75rem;
            height: 3px;
            background-color: white;
            border-radius: 3px 3px 0 0;
        }

        .nav-link i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }

        .dropdown-menu {
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-height: 80vh;
            overflow-y: auto;
        }

        .dropdown-item {
            white-space: normal;
        }

        .main-content {
            padding: 1rem;
            transition: padding 0.3s ease;
        }

    .emergency-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
    }

    .emergency-button {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: #dc3545;
        border: none;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.5);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        font-size: 0.8em
    }

    .emergency-button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
    }

    .emergency-button:active {
        transform: scale(0.95);
    }

    .emergency-pulse {
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }

    .location-status {
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 8px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    @media (max-width: 768px) {
        .emergency-button {
            width: 80px;
            height: 80px;
            font-size: 0.6em
        }
    }

        /* Mobile Styles */
        @media (max-width: 991.98px) {
            body {
                padding-top: var(--header-height-mobile);
            }

            .navbar-main {
                height: var(--header-height-mobile);
            }

            .navbar-brand {
                font-size: 1.1rem;
                padding: 0.25rem 0.5rem;
                margin-right: 0;
                order: 0;
            }

            /* Move navbar-toggler to the left */
            .navbar-toggler {
                padding: 0.25rem 0.5rem;
                order: -1;
            }

            .navbar-toggler:focus {
                box-shadow: none;
            }

            /* Keep notification and profile visible */
            .navbar-nav.top-nav {
                flex-direction: row;
                order: 1;
            }

            /* Main navigation goes full width when collapsed */
            .navbar-collapse {
                background: var(--navbar-bg);
                position: fixed;
                top: var(--header-height-mobile);
                left: 0;
                right: 0;
                max-height: calc(100vh - var(--header-height-mobile));
                overflow-y: auto;
                padding: 0.5rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }

            .navbar-collapse .nav-link {
                padding: 1rem;
                border-radius: 0.375rem;
            }

            .navbar-collapse .nav-link:hover,
            .navbar-collapse .nav-link.active {
                background-color: rgba(255, 255, 255, 0.1);
            }

            .navbar-collapse .nav-link.active::after {
                display: none;
            }

            /* Container for mobile nav layout */
            .mobile-nav-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }

            /* Mobile dropdown styles */
            .top-nav .dropdown-menu {
                position: absolute;
                min-width: 200px;
                width: auto;
                max-width: 250px;
                margin-top: 0.5rem;
                font-size: 0.875rem;
                padding: 0.25rem;
            }

            .top-nav .dropdown-item {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }

            .top-nav .dropdown-item i {
                font-size: 0.875rem;
                width: 16px;
                margin-right: 0.375rem;
            }

            .top-nav .dropdown-divider {
                margin: 0.25rem 0;
            }

            /* Main navigation dropdown stays full width */
            .navbar-collapse .dropdown-menu {
                width: 100%;
                margin: 0.25rem 0;
                padding: 0.25rem;
            }

            .top-nav .nav-link {
                padding: 0.5rem;
            }
            
            .top-nav .nav-link i {
                font-size: 1.1rem;
            }
        }

        /* Small Mobile Devices */
        @media (max-width: 575.98px) {
            .navbar-brand i {
                margin-right: 0.25rem;
            }

            .top-nav .nav-link {
                padding: 0.4rem;
            }

            .top-nav .nav-link i {
                font-size: 1rem;
            }

            .top-nav .dropdown-menu {
                min-width: 180px;
                max-width: 220px;
                font-size: 0.8125rem;
                right: -10px;  /* Adjust dropdown position */
            }

            .top-nav .dropdown-item {
                padding: 0.4375rem 0.625rem;
            }

            .main-content {
                padding: 0.75rem;
            }

            .alert {
                margin-bottom: 0.75rem;
                padding: 0.75rem;
            }
        }

        /* Add these new styles */
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .loading-state, .normal-state {
            display: inline-flex;
            align-items: center;
        }

        .d-none {
            display: none !important;
        }

        .navbar-nav .nav-link i {
            font-size: 1.2rem;
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>
<!-- Main Navigation -->
<nav class="navbar navbar-expand-lg navbar-main">
    <div class="container-fluid">
        <!-- Mobile Layout Container -->
        <div class="mobile-nav-container d-lg-none">
            <!-- Mobile Toggle -->
            <button class="navbar-toggler text-white border-0" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false"
                    aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>

            <!-- Brand -->
            <a class="navbar-brand d-flex align-items-center" href="{% url 'patient_management:dashboard' %}">
                <i class="fas fa-heartbeat me-2"></i>
                Prenatal Care
            </a>

            <!-- Top Nav Items (always visible) -->
            <ul class="navbar-nav top-nav">
                <!-- Profile -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-circle"></i>
                        <span class="d-none d-sm-inline-block ms-2">{{ request.user.get_full_name }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="{% url 'patient_management:profile_view' %}">
                                <i class="fas fa-user me-2"></i>Profile
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item text-danger" href="{% url 'patient_management:logout' %}">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>

        <!-- Desktop Layout -->
        <a class="navbar-brand d-none d-lg-flex align-items-center" href="{% url 'patient_management:dashboard' %}">
            <i class="fas fa-heartbeat me-2"></i>
            Prenatal Care
        </a>

        <!-- Navigation Items -->
        <div class="collapse navbar-collapse" id="navbarMain">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a href="{% url 'patient_management:dashboard' %}"
                       class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                        <i class="fas fa-home"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'patient_management:checkup_list' %}"
                       class="nav-link {% if 'checkups' in request.path %}active{% endif %}">
                        <i class="fas fa-calendar-check"></i>
                        Checkups
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'patient_management:vital_signs' %}"
                       class="nav-link {% if 'vital-signs' in request.path %}active{% endif %}">
                        <i class="fas fa-heartbeat"></i>
                        Vital Signs
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'patient_management:pregnancy_history_list' %}"
                       class="nav-link {% if 'pregnancy-history' in request.path %}active{% endif %}">
                        <i class="fas fa-history"></i>
                        History
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'patient_management:emergency_history' %}"
                       class="nav-link {% if 'emergency/history' in request.path %}active{% endif %}">
                        <i class="fas fa-ambulance"></i>
                        Emergency
                    </a>
                </li>
            </ul>

            <!-- Desktop Top Nav Items -->
            <ul class="navbar-nav d-none d-lg-flex">
                <!-- Profile -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-circle"></i>
                        <span class="ms-2">{{ request.user.get_full_name }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="{% url 'patient_management:profile_view' %}">
                                <i class="fas fa-user me-2"></i>Profile
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li>
                            <a class="dropdown-item text-danger" href="{% url 'patient_management:logout' %}">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content container-fluid">
    {% if messages %}
    {% for message in messages %}
    <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}

    {% block content %}{% endblock %}
</main>

<!-- Emergency Button -->
<div class="emergency-container">
    <button id="emergencyBtn" class="emergency-button emergency-pulse" onclick="confirmEmergency()">
        <div class="d-flex flex-column align-items-center justify-content-center h-100">
            <i class="fas fa-exclamation-triangle fa-2x text-white mb-1"></i>
            <span class="text-white fw-bold">EMERGENCY</span>
        </div>
    </button>
    <div id="locationStatus" class="location-status text-muted">
        <i class="fas fa-location-dot me-1"></i>Getting location...
    </div>
</div>

<!-- Emergency Modal -->
<div class="modal fade" id="emergencyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Emergency Alert
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-circle fa-4x text-danger mb-3"></i>
                    <h4>Confirm Emergency Alert</h4>
                </div>
                <p class="text-center mb-4">Are you sure you want to trigger an emergency alert?</p>
                <div class="alert alert-warning">
                    <p class="mb-2"><strong>This will:</strong></p>
                    <ul class="mb-0">
                        <li>Notify your assigned healthcare provider immediately</li>
                        <li>Share your current location</li>
                        <li>Record the emergency event</li>
                    </ul>
                </div>
                <!-- Add location details section -->
                <div id="locationDetails" class="alert alert-info mt-3" style="display: none;">
                    <h6 class="mb-2"><i class="fas fa-map-marker-alt me-2"></i>Your Location:</h6>
                    <div id="geocodedAddress" class="mb-2">Getting address...</div>
                    <div id="coordinatesInfo" class="small text-muted"></div>
                </div>
            </div>
            <div class="modal-footer justify-content-center border-0 pb-4">
                <button type="button" class="btn btn-lg btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-lg btn-danger" id="triggerAlertBtn" onclick="triggerEmergency()">
                    <span class="normal-state">
                        <i class="fas fa-exclamation-triangle me-2"></i>Trigger Alert
                    </span>
                    <span class="loading-state d-none">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Sending Alert...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Bootstrap Bundle JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
let userLocation = null;
let locationWatchId = null;
const MAX_LOCATION_AGE = 30000; // 30 seconds
const DESIRED_ACCURACY = 20; // 20 meters
const ACCURACY_TIMEOUT = 60000; // 1 minute

function updateLocationStatus(message, icon, colorClass) {
    document.getElementById('locationStatus').innerHTML = 
        `<i class="fas ${icon} ${colorClass} me-1"></i>${message}`;
}

function handleLocationError(error) {
    let errorMessage;
    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorMessage = "Please enable location access";
            break;
        case error.POSITION_UNAVAILABLE:
            errorMessage = "Location unavailable";
            break;
        case error.TIMEOUT:
            errorMessage = "Location request timed out";
            break;
        default:
            errorMessage = "Location error occurred";
    }
    updateLocationStatus(errorMessage, "fa-exclamation-circle", "text-danger");
    console.error('Location Error:', error.message);
    
    // Disable emergency button on location error
    const emergencyBtn = document.getElementById('emergencyBtn');
    emergencyBtn.disabled = true;
    emergencyBtn.style.opacity = '0.5';
    emergencyBtn.style.cursor = 'not-allowed';
}

function createGoogleMapsLink(latitude, longitude) {
    return `https://www.google.com/maps?q=${latitude},${longitude}`;
}

function updateLocationDetails(position) {
    const locationDetails = document.getElementById('locationDetails');
    const geocodedAddress = document.getElementById('geocodedAddress');
    const coordinatesInfo = document.getElementById('coordinatesInfo');
    
    locationDetails.style.display = 'block';
    
    // Format coordinates with more precision
    const latitude = position.coords.latitude.toFixed(6);
    const longitude = position.coords.longitude.toFixed(6);
    const accuracy = Math.round(position.coords.accuracy);
    const gmapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
    
    // Create detailed location information
    geocodedAddress.innerHTML = `
        <strong>Location Details:</strong><br>
        <strong>Accuracy:</strong> ${accuracy} meters<br>
        ${position.coords.altitude ? `<strong>Altitude:</strong> ${Math.round(position.coords.altitude)}m<br>` : ''}
        ${position.coords.speed ? `<strong>Speed:</strong> ${Math.round(position.coords.speed * 3.6)}km/h<br>` : ''}
        <strong>Last Updated:</strong> ${new Date(position.timestamp).toLocaleTimeString()}<br>
        <a href="${gmapsLink}" target="_blank" class="btn btn-sm btn-primary mt-2">
            <i class="fas fa-map-marker-alt me-1"></i>View on Google Maps
        </a>
    `;
    
    coordinatesInfo.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>Latitude: ${latitude}</span>
            <span>Longitude: ${longitude}</span>
        </div>
    `;
}

function initializeLocation() {
    if ("geolocation" in navigator) {
        // Disable emergency button initially
        const emergencyBtn = document.getElementById('emergencyBtn');
        emergencyBtn.disabled = true;
        emergencyBtn.style.opacity = '0.5';
        emergencyBtn.style.cursor = 'not-allowed';
        
        updateLocationStatus("Getting precise location...", "fa-location-dot", "text-muted");

        // Enhanced accuracy options
        const options = {
            enableHighAccuracy: true,
            timeout: ACCURACY_TIMEOUT,
            maximumAge: 0
        };

        try {
            // Use multiple location sources if available
            if ('DeviceOrientationEvent' in window) {
                window.addEventListener('deviceorientation', function(event) {
                    // Use compass data to improve accuracy
                    if (event.alpha !== null) {
                        // Store compass heading for better location accuracy
                        window.compassHeading = event.alpha;
                    }
                });
            }

            // Get initial position with high accuracy
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    handlePositionUpdate(position);
                    
                    // Enable emergency button once we have initial position
                    emergencyBtn.disabled = false;
                    emergencyBtn.style.opacity = '1';
                    emergencyBtn.style.cursor = 'pointer';
                    
                    // Continue watching for better accuracy
                    locationWatchId = navigator.geolocation.watchPosition(
                        handlePositionUpdate,
                        handleLocationError,
                        options
                    );

                    // Set timeout for continuous monitoring
                    setTimeout(() => {
                        if (locationWatchId !== null) {
                            navigator.geolocation.clearWatch(locationWatchId);
                            locationWatchId = null;
                            if (userLocation && userLocation.accuracy > DESIRED_ACCURACY) {
                                updateLocationStatus(
                                    `Best accuracy achieved: ${Math.round(userLocation.accuracy)}m`, 
                                    "fa-info-circle", 
                                    "text-warning"
                                );
                            }
                        }
                    }, ACCURACY_TIMEOUT);
                },
                function(error) {
                    handleLocationError(error);
                    // Keep emergency button disabled on error
                    emergencyBtn.disabled = true;
                    emergencyBtn.style.opacity = '0.5';
                    emergencyBtn.style.cursor = 'not-allowed';
                },
                { ...options, timeout: 10000 }
            );
        } catch (e) {
            updateLocationStatus("Location error", "fa-exclamation-circle", "text-danger");
            console.error("Geolocation error:", e);
            // Keep emergency button disabled on error
            emergencyBtn.disabled = true;
            emergencyBtn.style.opacity = '0.5';
            emergencyBtn.style.cursor = 'not-allowed';
        }
    } else {
        updateLocationStatus("Location not supported", "fa-times-circle", "text-danger");
        // Keep emergency button disabled if location is not supported
        const emergencyBtn = document.getElementById('emergencyBtn');
        emergencyBtn.disabled = true;
        emergencyBtn.style.opacity = '0.5';
        emergencyBtn.style.cursor = 'not-allowed';
    }
}

function handlePositionUpdate(position) {
    const accuracy = position.coords.accuracy;
    const newLocation = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude,
        accuracy: accuracy,
        timestamp: position.timestamp,
        altitude: position.coords.altitude,
        altitudeAccuracy: position.coords.altitudeAccuracy,
        heading: position.coords.heading,
        speed: position.coords.speed
    };

    // Only update if the new location is more accurate
    if (!userLocation || newLocation.accuracy < userLocation.accuracy) {
        userLocation = newLocation;
        
        // Enable emergency button if we have a valid location
        const emergencyBtn = document.getElementById('emergencyBtn');
        emergencyBtn.disabled = false;
        emergencyBtn.style.opacity = '1';
        emergencyBtn.style.cursor = 'pointer';
        
        // Update status based on accuracy
        if (accuracy <= DESIRED_ACCURACY) {
            updateLocationStatus(
                `Location accurate (${Math.round(accuracy)}m)`, 
                "fa-check-circle", 
                "text-success"
            );
            // Stop watching if we achieved desired accuracy
            if (locationWatchId !== null) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            // Update location details in modal
            updateLocationDetails(position);
        } else if (accuracy <= 100) {
            updateLocationStatus(
                `Location accuracy: ${Math.round(accuracy)}m`, 
                "fa-info-circle", 
                "text-warning"
            );
            updateLocationDetails(position);
        } else {
            updateLocationStatus(
                `Improving accuracy (${Math.round(accuracy)}m)...`, 
                "fa-sync", 
                "text-info"
            );
        }
    }
}

// Initialize location tracking when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Check if we need to request permissions first
    if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({ name: 'geolocation' })
            .then(permission => {
                if (permission.state === "granted") {
                    initializeLocation();
                } else if (permission.state === "prompt") {
                    updateLocationStatus("Please allow location access", "fa-location-dot", "text-warning");
                    const emergencyBtn = document.getElementById('emergencyBtn');
                    initializeLocation();
                    emergencyBtn.disabled = true;
                    emergencyBtn.style.opacity = '0.5';
                    emergencyBtn.style.cursor = 'not-allowed';
                    emergencyBtn.addEventListener('click', function() {
                        initializeLocation();
                    });
                } else {
                    updateLocationStatus("Location access denied", "fa-times-circle", "text-danger");
                    const emergencyBtn = document.getElementById('emergencyBtn');
                    emergencyBtn.disabled = true;
                    emergencyBtn.style.opacity = '0.5';
                    emergencyBtn.style.cursor = 'not-allowed';
                }
            });
    } else {
        initializeLocation();
    }
});

// Cleanup on page unload
window.addEventListener('unload', function() {
    if (locationWatchId !== null) {
        navigator.geolocation.clearWatch(locationWatchId);
    }
});

function confirmEmergency() {
    const modal = new bootstrap.Modal(document.getElementById('emergencyModal'));
    modal.show();
    
    // If we have a location, show it in the modal
    if (userLocation) {
        updateLocationDetails({
            coords: {
                latitude: userLocation.latitude,
                longitude: userLocation.longitude,
                accuracy: userLocation.accuracy,
                altitude: userLocation.altitude,
                speed: userLocation.speed
            },
            timestamp: userLocation.timestamp
        });
    }
}

function triggerEmergency() {
    const triggerBtn = document.getElementById('triggerAlertBtn');
    const normalState = triggerBtn.querySelector('.normal-state');
    const loadingState = triggerBtn.querySelector('.loading-state');
    
    // Disable button and show loading state
    triggerBtn.disabled = true;
    normalState.classList.add('d-none');
    loadingState.classList.remove('d-none');

    // Get location data
    const locationData = userLocation ? {
        coordinates: `${userLocation.latitude},${userLocation.longitude}`,
        accuracy: userLocation.accuracy,
        altitude: userLocation.altitude,
        speed: userLocation.speed,
        timestamp: new Date().toISOString()
    } : null;

    fetch("{% url 'patient_management:emergency_alert' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            location: locationData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Instead of using window.location.href, use window.location.replace with cache-busting
            const timestamp = new Date().getTime();
            window.location.replace(`{% url 'patient_management:emergency_history' %}?t=${timestamp}`);
        } else {
            // Reset button state
            triggerBtn.disabled = false;
            normalState.classList.remove('d-none');
            loadingState.classList.add('d-none');
            
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Emergency alert error:', error);
        
        // Reset button state
        triggerBtn.disabled = false;
        normalState.classList.remove('d-none');
        loadingState.classList.add('d-none');
        
        alert('Error triggering emergency alert. Please call emergency services directly.');
    });
}
</script>
{% block extra_js %}{% endblock %}
</body>
</html>